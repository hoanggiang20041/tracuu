<!DOCTYPE html>
<html lang="vi">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Gia hạn bảo hành</title>
	<link rel="stylesheet" href="assets/style.css" />
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .renew-wrap{max-width:920px;margin:40px auto;padding:24px;border-radius:20px;background:rgba(17,24,39,0.9);box-shadow:0 20px 60px rgba(0,0,0,.1)}
        .renew-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        .renew-field{display:flex;flex-direction:column;gap:6px}
        .renew-field input{padding:12px;border:1px solid #e5e7eb;border-radius:10px}
        .renew-actions{margin-top:14px;display:flex;gap:10px}
    </style>
</head>
<body class="dark">
    <div class="renew-wrap">
        <h2 style="margin-bottom:10px">Gia hạn bảo hành</h2>
        <div id="renew-info" style="color:#9ca3af;margin-bottom:12px"></div>
        <div class="renew-grid">
            <div class="renew-field">
                <label>Số ngày gia hạn</label>
                <input id="renew-days" type="number" min="1" value="30" oninput="updateRenewAmount()" />
            </div>
            <div class="renew-field">
                <label>Mã giảm giá (nếu có)</label>
                <input id="renew-discount" type="text" placeholder="GIAM10" style="text-transform:uppercase" oninput="updateRenewAmount()" />
            </div>
        </div>
        <div style="margin-top:12px">
            <div>Số tiền cần chuyển: <strong id="renew-amount">0 đ</strong></div>
            <div id="renew-content" style="color:#9ca3af"></div>
            <div class="renew-actions">
                <button class="download-btn" onclick="copyRenewContent()"><i class="fas fa-copy"></i> Sao chép nội dung</button>
            </div>
        </div>
        <div style="text-align:center;margin-top:12px">
            <div style="font-weight:600; color:#e5e7eb; margin-bottom:6px;">QR MB (68610042009 - NGUYỄN HOÀNG GIANG)</div>
            <img id="renew-qr" src="" alt="QR chuyển khoản" style="width:260px;height:260px;background:#fff;border-radius:12px;padding:8px" />
        </div>
        <div style="margin-top:12px">
            <label>Tải ảnh hóa đơn/bill</label>
            <input id="renew-bill" type="file" accept="image/*" />
        </div>
        <div class="renew-actions" style="justify-content:flex-end">
            <a class="download-btn" href="index.html" style="text-decoration:none"><i class="fas fa-arrow-left"></i> Quay lại</a>
            <button class="download-btn" onclick="submitRenewRequest()"><i class="fas fa-paper-plane"></i> Gửi yêu cầu</button>
        </div>
    </div>

    <script src="assets/remote-store.js"></script>
    <script>
        function getQuery(){ const p=new URLSearchParams(location.search); return { id:p.get('id')||'', name:decodeURIComponent(p.get('name')||'') }; }
        function getAdminExtrasSync(){ try{const c=localStorage.getItem('admin_extras');return c?JSON.parse(c):{pricing:{tiers:[{label:'1 tuần',days:7,price:200000}]},discounts:[]};}catch(_){return {pricing:{tiers:[{label:'1 tuần',days:7,price:200000}]},discounts:[]};}}
        function updateRenewAmount(){ const extras=getAdminExtrasSync(); const q=getQuery(); document.getElementById('renew-info').textContent=`Khách hàng: ${q.name} (${q.id})`; const days=Math.max(1,parseInt(document.getElementById('renew-days').value||'30',10)); const tiers=(extras.pricing&&extras.pricing.tiers)?extras.pricing.tiers:[{label:'1 tuần',days:7,price:200000}]; const perDay=Math.round((tiers[0].price)/(tiers[0].days)); let amount=days*perDay; for(const t of tiers){ const packs=Math.floor(days/t.days); const rem=days%t.days; const cost=packs*t.price+rem*perDay; if(cost<amount) amount=cost;} const code=(document.getElementById('renew-discount').value||'').trim().toUpperCase(); if(code && days>=31){ const f=(extras.discounts||[]).find(d=>d.code===code && (!d.expire || new Date(d.expire)>=new Date())); if(f && days>=(f.minDays||31)){ amount=Math.round(amount*(100-f.percent)/100); }} document.getElementById('renew-amount').textContent=amount.toLocaleString('vi-VN')+' đ'; const content=`${q.id}_${(q.name||'').toUpperCase().replace(/\s+/g,' ')}_${days}`; document.getElementById('renew-content').textContent='Nội dung chuyển khoản: '+content; const qr=`https://img.vietqr.io/image/MB-68610042009-compact.png?amount=${amount}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent('NGUYEN HOANG GIANG')}`; document.getElementById('renew-qr').src=qr; }
        function copyRenewContent(){ const t=document.getElementById('renew-content').textContent.replace('Nội dung chuyển khoản: ',''); navigator.clipboard.writeText(t).then(()=>alert('Đã sao chép nội dung')); }
        async function submitRenewRequest(){ try{ const q=getQuery(); const days=Math.max(1,parseInt(document.getElementById('renew-days').value||'30',10)); const amount=parseInt((document.getElementById('renew-amount').textContent||'0').replace(/\D/g,''),10)||0; const content=document.getElementById('renew-content').textContent.replace('Nội dung chuyển khoản: ',''); const file=document.getElementById('renew-bill').files[0]; let billUrl=''; if(file){ const form=new FormData(); form.append('image',file); const r=await fetch('https://api.imgbb.com/1/upload?key=d46a4b1117287a127e5ae5e55e193046',{method:'POST',body:form}); const j=await r.json(); if(j.success) billUrl=j.data.url; } const remote=window.remoteStore; let state={}; if(remote && remote.getAdminState){ try{ state=await remote.getAdminState()||{}; }catch(_){ state={}; } } const renewals=Array.isArray(state.renewals)?state.renewals:[]; renewals.push({id:q.id,name:q.name,days,amount,content,billUrl,status:'pending',createdAt:Date.now()}); state.renewals=renewals; if(remote && remote.isConfigured && remote.isConfigured() && remote.setAdminState){ await remote.setAdminState(state); } else { try{ const cached=localStorage.getItem('admin_extras'); const extras=cached?JSON.parse(cached):{}; extras.renewals=renewals; localStorage.setItem('admin_extras', JSON.stringify(extras)); }catch(_){} } alert('Đã gửi yêu cầu gia hạn. Vui lòng chờ admin duyệt.'); location.href='index.html'; } catch(e){ alert('Lỗi gửi yêu cầu: '+e.message); } }
        document.addEventListener('DOMContentLoaded', updateRenewAmount);
    </script>
</body>
</html>


